2026/2/17 

我准备在路径下“D:\MyProject\Planning-app”创建一个新项目。 人生就是一场选择题，我希望以《易经》为主题，做一个”规划软件“，为大家趋利避凶。 人生规划、职业规划、项目规划、心情规划、饮食规划、健康规划、时间规划、习惯规划... 就是做个规划系统以此系统来实现我的诉求。

目前我电脑上装的软件如下

**node**	v22.20.0

**npm**	10.9.3

**mysql**	8.0.43.0

**Hbuilderx** 	v4.76

**git** 	 2.51.0.windows.2

GitHub上SSH：git@github.com:davidisgreat1128-collab/planning-app.git

前端使用Uniapp开发，安卓、苹果、H5

数据库使用MySql	

后端使用Node.js+ExpressG



你是这企业级项目的总包，请规划一下该项目的前期准备，一定要按照企业级别来执行，不允许忽悠我

诉求：

1.先查看该项目下的所有文件

2.设计文件结构。什么文件做什么事情，要告诉我

3.git也需要按照企业项目来做好前期规划


---

## 2026/2/20

### 问题：访客模式白屏问题修复

**背景**：
用户在手机上安装 APP 后出现白屏，显示"网络连接失败，请检查网络"错误。原因是 APP 尝试连接 `http://127.0.0.1:3000`（localhost），但手机的 localhost 与 PC 的 localhost 不同。

**解决方案**：
实现访客模式（Guest Mode），允许用户在无后端连接的情况下体验 UI 和演示数据。

### 修复过程

#### 第一阶段：访客模式基础实现
**问题**：开启访客模式后仍然白屏

**根本原因（多个）**：
1. `pages.json` 配置错误：`pages/calendar/index` 为第一个页面，导致 App 启动时自动进入该页面并发起网络请求
2. 时序冲突：UniApp 自动进入首页 + App.vue 的 onLaunch 也在 100ms 后 reLaunch → 页面反复刷新
3. `profile.vue` 也有网络请求，访客模式下点击"我的"会白屏
4. 旧版本缓存数据结构不兼容

**修复方案（三步）**：
1. **修改 `pages.json`**：将 `pages/user/login` 调整为第一个页面（启动首页）
2. **修改 `pages/user/profile.vue`**：在 `checkLoginAndLoad()` 中添加访客模式检查，跳过网络请求
3. **修改 `App.vue`**：启动时清除旧版本缓存数据

**提交**：`94fab5a` - fix(frontend): 彻底修复访客模式白屏问题（三步修复：启动页+缓存+profile）

#### 第二阶段：优化启动逻辑
**问题**：App 显示 logo 后仍然白屏，未进入登录页

**根本原因**：
`pages.json` 已将 login 设为首页，但 `App.vue` 的 onLaunch 仍在 100ms 后执行 `reLaunch` 到 login 页面 → 重复进入同一页面 → 白屏

**修复方案**：
调整 `App.vue` 的 onLaunch 逻辑：
- 有 token：reLaunch 到主页
- 访客模式：reLaunch 到主页
- 普通模式 + 无 token：停留在 login 页（无需 reLaunch）

**提交**：`e761c21` - fix(frontend): 修复App.vue启动逻辑（login为首页后无需重复reLaunch）

#### 第三阶段：完全清除缓存
**问题**：H5 端运行时直接登录，未进入登录页

**根本原因**：
缓存清除逻辑保留了 `planning_app_token`，然后 `getToken()` 读取到 token → 判断为已登录 → 跳转主页

**修复方案**：
启动时使用 `uni.clearStorageSync()` 完全清除所有缓存（测试阶段）

**提交**：`39b0f25` - fix(frontend): 启动时完全清除缓存（测试模式），确保进入登录页

**TODO**：正式发布时改为按版本号判断是否清除缓存

#### 第四阶段：登录页渲染调试
**问题**：用户反馈"还是看不到登录页面"

**调试步骤**：
1. 在 `login.vue` 添加 console.log 调试日志
2. 修复 `login.vue` 缺少 `onMounted` 导入（之前使用了 `onLoad` 但未导入）
3. 请求用户提供浏览器控制台日志

**发现**：
通过控制台日志发现，登录页实际已正常加载，用户是立即点击了访客模式切换按钮

**提交**：`e9567bc` - debug: 添加登录页调试日志

#### 第五阶段：访客模式只读保护
**问题**：访客模式下点击任务复选框触发网络请求，控制台出现多个 401 错误

**用户提供的控制台日志**：
```
[Request] PUT http://127.0.0.1:3000/api/v1/tasks/1 401 (Unauthorized)
[Request] PUT http://127.0.0.1:3000/api/v1/tasks/2 401 (Unauthorized)
...
```

**根本原因**：
`toggleTaskDone()` 和 `toggleSubtask()` 函数未检查访客模式，直接调用 API

**修复方案**：
在两个函数开头添加访客模式检查：
```javascript
if (userStore.token === 'guest') {
  uni.showToast({
    title: '访客模式下无法修改任务，请登录后使用',
    icon: 'none',
    duration: 2000
  });
  return;
}
```

**提交**：`d2ef9e7` - fix(frontend): 访客模式下禁止修改任务（防止网络请求错误）

### 最终效果

✅ **访客模式完整流程**：
1. App 启动 → 清除所有缓存
2. 自动进入登录页（无网络请求）
3. 用户点击 🔓 图标 → 启用访客模式
4. 跳转到主页 → 加载 5 条演示任务（覆盖四象限）
5. 可切换四象限/时间轴视图，体验完整 UI
6. 点击任务复选框 → 显示友好提示（不发起网络请求）
7. TabBar 点击"我的" → 显示"访客"信息（不请求后端）

✅ **无白屏、无报错、流畅使用**

### 涉及文件

1. `frontend/Planning-app/pages/calendar/index.vue` - 访客模式演示数据 + 只读保护
2. `frontend/Planning-app/utils/request.js` - 401 静默处理
3. `frontend/Planning-app/pages.json` - 启动首页调整
4. `frontend/Planning-app/pages/user/profile.vue` - 访客模式跳过请求
5. `frontend/Planning-app/App.vue` - 缓存清除 + 启动逻辑优化
6. `frontend/Planning-app/pages/user/login.vue` - 调试日志
7. `frontend/Planning-app/store/user.js` - enterGuestMode() 方法

### 技术要点

- **UniApp 启动序列**：pages.json 第一个页面自动加载，App.vue onLaunch 并发执行
- **访客模式实现**：token = 'guest'，存储在 localStorage
- **演示数据**：5 条任务覆盖四象限（红、蓝、黄、绿）+ 时间轴视图
- **只读保护**：所有修改操作检查访客模式，显示友好提示
- **401 处理**：访客模式下静默 resolve，正常模式下跳转登录页

