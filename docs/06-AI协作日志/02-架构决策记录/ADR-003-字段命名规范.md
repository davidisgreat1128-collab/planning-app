# ADR-003: 数据库与JS字段命名映射方案

| 字段 | 内容 |
|------|------|
| 编号 | ADR-003 |
| 日期 | 2026-02-17 |
| 状态 | 已接受 |
| 决策人 | 唐伯虎 + Claude AI |

## 背景

数据库惯例使用 `snake_case`（如 `user_id`, `created_at`），
而 JavaScript 惯例使用 `camelCase`（如 `userId`, `createdAt`）。

如果不统一处理，代码中会出现大量手动转换，容易出错且难以维护。

## 问题

```javascript
// 不统一时容易犯的错误：
const record = await PlanningRecord.create({
  user_id: userId,    // DB字段？还是JS属性？
  userId: userId,     // 哪个是正确的？
  startDate: date,    // 前端传过来的camelCase
  start_date: date    // DB存储的snake_case
});
```

## 决策

使用 **Sequelize `underscored: true`** 配置，在 ORM 层自动完成双向映射：

```javascript
// backend/src/config/database.js
define: {
  underscored: true,  // ⭐ 核心：自动 camelCase ↔ snake_case
  timestamps: true,
  paranoid: true
}
```

### 映射规则（自动处理）

| JavaScript属性 | 数据库列名 | 说明 |
|----------------|------------|------|
| `userId` | `user_id` | 外键 |
| `createdAt` | `created_at` | 时间戳 |
| `updatedAt` | `updated_at` | 时间戳 |
| `deletedAt` | `deleted_at` | 软删除 |
| `passwordHash` | `password_hash` | 密码哈希 |
| `startDate` | `start_date` | 日期字段 |
| `ichingAdvice` | `iching_advice` | JSON字段 |

### 统一约定

| 层次 | 字段格式 | 强制要求 |
|------|----------|----------|
| 数据库（MySQL） | `snake_case` | 必须 |
| Sequelize模型属性 | `camelCase` | 必须 |
| 后端Controller/Service | `camelCase` | 必须 |
| 前端（UniApp/JS） | `camelCase` | 必须 |
| API请求/响应JSON | `camelCase` | 必须 |

**结论：** 数据库之外，所有地方统一使用 `camelCase`，Sequelize 负责自动转换。

## 备选方案

| 方案 | 拒绝理由 |
|------|----------|
| 全用snake_case | 违反JS惯例，所有代码都很别扭 |
| 全用camelCase | MySQL不支持，且违反SQL惯例 |
| 手动转换 | 工作量大，容易漏掉某处，产生Bug |
| 库级转换（如humps） | 额外依赖，且不如ORM层透明 |

## 后果

- 零手动转换代码
- 前后端字段名完全一致（都是camelCase）
- 数据库可视化工具查看时字段可读性好（snake_case）
- 新增字段时只需在Sequelize模型中用camelCase定义，DB自动生成snake_case列
